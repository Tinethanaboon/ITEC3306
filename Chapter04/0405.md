## การใช้งานภาษาเอสคิวแอลผ่านคำสั่งของภาษาพีเอชพี
การใช้งานภาษาเอสคิวแอล (SQL) ผ่านคำสั่งของภาษาพีเอชพี (PHP) จะอธิบายโดยใช้หลักการเขียนโปรแกรมบนเว็บ ประกอบด้วย การเลือก (SELECT) การเพิ่มข้อมูล (INSERT) การปรับปรุงข้อมูล (UPDATE) และ การลบข้อมูล (DELETE) ตามขั้นตอนการติดต่อฐานข้อมูลที่อธิบายไว้ในก่อนหน้านี้  โดยจะเริ่มจากการสร้างฐานข้อมูลชื่อ “db_chapter04” และ ตารางสินค้า ชื่อ “Products” ผ่านพีเอชพีมายแอดมิน (PHPmyAdmin) 

<img src=img/0426.png>

---
## การเตรียมเนื้อหาเบื้องต้น
---
ทำการสร้างฐานข้อมูล ชื่อ db_chapter04 และ นำเข้าโครงสรา้งข้อมูลทดสอบจากไฟล์ 

โดยนำเข้าจากไฟล์ [db_chapter04.sql](src/db_chapter04.sql) จะได้โครงสร้างและข้อมูลทดสอบ ประกอบด้วย

```
    Products, Suppliers และ Categories 
```

ดังภาพ

<img src=img/db_chapter04.png>
---

### การนำแถวในตารางมาแสดงผลบนเว็บ
การเขียนโปรแกรมบนเว็บเพื่อติดต่อกับฐานข้อมูลมีวัตถุประสงค์ที่สำคัญคือ การแสดงผลข้อมูลในรูปแบบไดนามิคเว็บ ซึ่งการนำข้อมูลจากฐานข้อมูลมาแสดงในรูปแบบตารางบนเว็บไซต์เป็นพื้นฐานสำคัญที่ผู้พัฒนาควรศึกษาและทำความเข้าใจ โดยในที่นี้จะแสดงตัวอย่างการเขียนโปรแกรมอ่านตารางข้อมูลมาแสดงผลบนเว็บ ดังตัวอย่างโปรแกรม

```
01:<HTML>
02:<HEAD>
03:<TITLE>SELECT TABLE</TITLE>
04:</HEAD>
05:<BODY>
06:<?php 
07:	    $conn = mysqli_connect('localhost', 'root', '');
08:	    $db = mysqli_select_db($conn, 'db_chapter04');
09:	    mysqli_query($conn, 'SET character_set_results=utf8');
10:	    mysqli_query($conn, 'SET character_set_client=utf8');
11:	    mysqli_query($conn, 'SET character_set_connection=utf8');
12:	    $sql = "SELECT p.*, s.SupplierName, c.CategoryName 
13:	               FROM ((Products p
14:	               INNER JOIN Suppliers s ON p.SupplierID = s.SupplierID)
15:	               INNER JOIN Categories c ON p.CategoryID = c.CategoryID);";
16:	     $result = mysqli_query($conn, $sql); // ประมวลผลคำสั่ง SQL
17:	    echo "<TABLE border='1' width='100%'>";
18:	    echo "<TR align='center'>";
19:	                <TH>รหัส</TH>
17:	                <TH>รายการ</TH>
18:	                <TH>ผู้ผลิต</TH>
19:	                <TH>ประเภท</TH>
20:	                <TH>หน่วยนับ</TH>
21:	                <TH>ราคา</TH>
22:	            </TR>";
23:	    while($row = mysqli_fetch_array($result)) { // เก็บผลลัพธ์ในอาเรย์
24:	        echo "<TR>";
25:	            echo "<TD>".$row['ProductID']."</TD>";
26:	            echo "<TD>".$row['ProductName']."</TD>";
27:	            echo "<TD>".$row['SupplierID']."</TD>";
28:	            echo "<TD>".$row['CategoryID']."</TD>";
29:	            echo "<TD>".$row['Unit']."</TD>";
30:	            echo "<TD>".$row['Price']."</TD>";
31:	        echo "</TR>";
32:	    }
33:	    echo "</TABLE>";
34:	    mysqli_close($conn);
35:?>
36:</BODY>
37:</HTML>
```

[ดาวน์โหลด source code](src/ch04_01.php)

จากตัวอย่างโปรแกรม บรรทัดที่ 07 เป็นการเชื่อมต่อกับระบบจัดการฐานข้อมูลมายเอสคิวแอล (MySQL) บรรทัดที่ 08-11 เป็นการเลือกฐานข้อมูลที่ต้องการใช้งานรวมทั้งตั้งค่ารหัสชุดอักษรที่เรียกใช้แสดงผลลัพธ์ด้วยคำสั่งเอชคิวแอล (SQL) บรรทัดที่ 12-16 จะทำการกำหนดและประมวลคำสั่งเอชคิวแอล (SQL) บรรทัดที่ 23 จะใช้คำสั่งวนรอบเพื่อเก็บผลลัพธ์ในตัวแปรอาเรย์ และในบรรทัดที่ 34 เป็นการปิดการเชื่อมต่อกับฐานข้อมูล ซึ่งหลังจากรันโปรแกรมจะได้ผลลัพธ์ ดังภาพ

<img src=img/0427.png>


### การเพิ่มแถวใหม่ไปในตารางข้อมูล
การเขียนโปรแกรมเพื่อเพิ่มแถวของข้อมูลใหม่ในตาราง โดยทั่วไปจะต้องสร้างฟอร์มสำหรับการเพิ่มข้อมูล จากนั้นจึงส่งค่าจากฟอร์มไปยังฐานข้อมูลเพื่อเพิ่มข้อมูลระเบียนใหม่ โดยในที่นี้จะแสดงตัวอย่างการเขียนโปรแกรมการเพิ่มระเบียนใหม่เพื่อให้เข้าใจหลักการทำงาน ดังตัวอย่างโปรแกรม


```
01:<?php
02:	    $conn=mysqli_connect("localhost","root","");
03:	    $db=mysqli_select_db($conn, "db_chapter04");
04:	    mysqli_query($conn, "SET character_set_results=utf8");
05:	    mysqli_query($conn, "SET character_set_client=utf8");
06:	    mysqli_query($conn, "SET character_set_connection=utf8");
07:	    $sql="INSERT INTO  Products (ProductId,  ProductName, 
08:	        SupplierId,  CategoryId, Unit, Price) 
09:	        VALUES (NULL ,  'ไม้บรรทัด',  '1',  '1',  'อัน',  '13');"; // กำหนดคำสั่ง SQL
10:	    $result=mysqli_query($conn, $sql); // ประมวลผลคำสั่ง SQL
11:	    mysqli_close($conn);
12:	    echo "<META http-equiv='refresh' content='0; url=ch04_01.php'>";
13:?>
```

[ดาวน์โหลด source code](src/ch04_02.php)


จากตัวอย่างโปรแกรม บรรทัดที่ 07-09 เป็นคำสั่งเอสคิวแอล (SQL) ที่ใช้ในการเพิ่มข้อมูลระเบียนใหม่ลงในตารางสินค้า (Products) และในบรรทัดที่ 12 เป็นคำสั่งแสดงรายการที่เพิ่มใหม่ในตาราง โดยผลลัพธ์ที่ได้แสดงดังภาพ

<img src=img/0428.png>


### การปรับปรุงแถวของตารางข้อมูล
การเขียนโปรแกรมเพื่อปรับปรุงข้อมูลของแถวในตารางข้อมูล โดยทั่วไปจะต้องสร้างฟอร์มสำหรับปรับปรุงข้อมูลแบบเดียวกับการเพิ่มข้อมูลใหม่ จากนั้นจึงส่งค่าจากฟอร์มไปยังฐานข้อมูลเพื่อปรับปรุงข้อมูลของแถวโดยใช้คีย์หลักในการอ้างอิง ในเบื้องต้นนี้ จะสมมุติว่ามีข้อมูลที่จะปรับปรุงขึ้นมา เพื่อให้เข้าใจหลักการทำงาน ตามตัวอย่างโปรแกรม
 
```
01:<?php
02:	   $conn=mysqli_connect("localhost","root","");
03:	   $db=mysqli_select_db($conn, "db_chapter04");
04:	   mysqli_query($conn, "SET character_set_results=utf8");
05:	   mysqli_query($conn, "SET character_set_client=utf8");
06:	   mysqli_query($conn, "SET character_set_connection=utf8");
07:	   $sql="UPDATE  Products SET Price = '10' 
08:	           WHERE ProductID = '4';"; // กำหนดคำสั่ง SQL
09:	   $result=mysqli_query($conn, $sql); // ประมวลผลคำสั่ง SQL
10:	   mysqli_close($conn);
11:	   echo "<META http-equiv='refresh' content='0; url=ch04_01.php'>";
12:?>
```

[ดาวน์โหลด source code](src/ch04_03.php)

จากตัวอย่างโปรแกรม บรรทัดที่ 07-09 เป็นคำสั่งเอสคิวแอล (SQL) ที่ใช้ในการปรับปรุงข้อมูลในระเบียนข้อมูลของตารางสินค้า (Products) โดยปรับปรุงข้อมูลราคาสินค้าจาก 13 บาท เป็น 10 บาท และมีการกำหนดเงื่องไขว่าให้ปรับปรุงข้อมูลในรายการสินค้าที่มีรหัสสินค้า (ProductID) เท่ากับ 4 และในบรรทัดที่ 11 เป็นคำสั่งแสดงรายการสินค้าที่มีการปรับปรุงจากตารางสินค้า โดยผลลัพธ์ที่ได้แสดงดังภาพ

<img src=img/0429.png>

### การลบแถวในตารางข้อมูล
การเขียนโปรแกรมลบแถวในตารางข้อมูล โดยทั่วไปจะต้องสร้างลิงค์สำหรับลบรายการจากหน้าจอแสดงข้อมูล เมื่อคลิกลิงค์ลบดังกล่าวจึงจะส่งออกค่าคีย์หลักเพื่อนำไปจัดการในขั้นการติดต่อฐานข้อมูลเพื่อลบแถวนั้นโดยอ้างอิงคีย์หลักดังกล่าว ในเบื้องต้นนี้ จะสมมติว่ามีคีย์หลักที่จะลบออกจากตารางขึ้นมา เพื่อให้เข้าใจหลักการทำงาน ตามตัวอย่างโปรแกรม
 
```
01:<?php
02:	    $conn=mysqli_connect("localhost","root","");
03:	    $db=mysqli_select_db($conn, "db_chapter04");
04:	    mysqli_query($conn, "SET character_set_results=utf8");
05:	    mysqli_query($conn, "SET character_set_client=utf8");
06:	    mysqli_query($conn, "SET character_set_connection=utf8");
07:	    $sql="DELETE FROM Products 
08:	            WHERE ProductID = '3';"; // กำหนดคำสั่ง SQL
09:	    $result=mysqli_query($conn, $sql); // ประมวลผลคำสั่ง SQL
10:	    mysqli_close($conn);
11:	    echo "<META http-equiv='refresh' content='0; url=ch04_01.php'>";
12:?>
```

[ดาวน์โหลด source code](src/ch04_04.php)

จากตัวอย่างโปรแกรม บรรทัดที่ 07-09 เป็นคำสั่งเอสคิวแอล (SQL) ที่ใช้ในการลบข้อมูลในระเบียนข้อมูลของตารางสินค้า (Products) โดยมีการกำหนดเงื่องไขว่า ลบสินค้าที่มีรหัสสินค้า (ProductID) เท่ากับ 3 และในบรรทัดที่ 11 เป็นคำสั่งแสดงรายการสินค้าทั้งหมดในตารางสินค้า โดยผลลัพธ์ที่ได้แสดงดังภาพ

<img src=img/0430.png>

จากโปรแกรมตัวอย่าง บรรทัดที่ 02-06 ของทุกโปรแกรมจะเป็นการใช้ชุดคำสั่งเชื่อมต่อข้อมูล การเลือกฐานข้อมูล และการปรับภาษาสำหรับการติดต่อมายเอสคิวแอลเหมือนกัน ดังนั้น เพื่อให้สามารถในการแก้ไขโปรแกรมเพียงจุดเดียว สามารถแยกส่วนดังกล่าวไปเขียนไว้ในที่เดียวกันซึ่งจะอำนวยความสะดวกรวดเร็วในการพัฒนาโปรแกรม ตามตัวอย่างโปรแกรม

```
01:<?php // http://localhost/form/connection.php
02:	    $conn=mysqli_connect("localhost","root","");
03:	    $db=mysqli_select_db($conn, "db_chapter04");
04:	    mysqli_query($conn, "SET character_set_results=utf8");
05:	    mysqli_query($conn, "SET character_set_client=utf8");
06:	    mysqli_query($conn, "SET character_set_connection=utf8");
07:?>
```

[ดาวน์โหลด source code](src/ch04_05.php)

ตามตัวอย่างโปรแกรม เมื่อโปรแกรมใดก็ตามที่ต้องการเชื่อมต่อฐานข้อมูล “db_chapter04” สามารถเรียกประมวลผลส่วนที่ได้โดยใช้คำสั่ง include ดังนี้

```
include "connection.php";
```

จากตัวอย่างข้างต้นเป็นการสั่งให้เรียกประมวลผลไฟล์ “connection.php” ซึ่งเป็นส่วนที่ทำหน้าที่เชื่อมต่อกับฐานข้อมูล “db_chapter04” และทำการตั้งค่าภาษาในการสื่อสารด้วยภาษาเอสคิวแอล (SQL) ให้รองรับระบบภาษาไทย โดยจะเขียนคำสั่งดังกล่าวไว้ก่อนส่วนของคำสั่งสำหรับดำเนินการจัดการตารางข้อมูลภายในฐานข้อมูล “db_shop chapter04” นอกจากนี้ การเขียนโปรแกรมบนเว็บยังมีฟังก์ชันภาษาพีเอชพี (PHP) ที่สำคัญและเกี่ยวข้องกับการใช้งานมายเอสคิวแอล (MySQL) ดังสรุปไว้ในตาราง

| ฟังก์ชัน |	รายละเอียด |
| --- | --- |
| mysqli_connect() | เชื่อมต่อมายเอสคิวแอล (MySQL) |
| mysqli_select_db() | เลือกฐานข้อมูลที่ต้องการใช้งาน |
| mysqli_query() | นำคำสั่งเอสคิวแอล (SQL) ไปประมวลผล |
| mysqli_db_query() | นำคำสั่งเอสคิวแอล (SQL) ไปประมวลผล |
| mysqli_error() | แสดงข้อผิดพลาดของคำสั่งเอสคิวแอล (SQL) |
| mysqli_affected_rows() | แสดงจำนวนแถวที่ได้รับผลกระทบในการทำคำสั่งเอสคิวแอล (SQL) |
| mysqli_num_fields() |	นับจำนวนเขตข้อมูลของตาราง |
| mysqli_num_rows() | นับจำนวนแถวของข้อมูล |
| mysqli_fetch_field() | นำชื่อเขตข้อมูลออกมาใช้งาน |
| mysqli_ fetch_array() | นำข้อมูลออกมาใช้งานทีละแถวในรูปแบบอาร์เรย์ |
| mysqli_ close() | ปิดการเชื่อมต่อมายเอสคิวแอล (MySQL) |

---
#### [<< หน้าก่อนหน้า](0404.md) | [หน้าเลือกหัวข้อ](README.md) | [หน้าต่อไป >>](0410.md)
---
