## การจัดการคุกกี้ด้วยภาษาพีเอชพี
	
คุกกี้ (Cookie) เป็นวิธีการเก็บข้อมูลขนาดเล็กชั่วคราวไว้ที่เครื่องฝั่งเว็บไคลเอ็นต์หรือเครื่องผู้ใช้งานเว็บไซต์เอง โดยปกติแล้วเว็บเบราว์เซอร์ใช้คุกกี้ในการจัดเก็บข้อมูลผู้ใช้หลายส่วน เช่น การเก็บค่าที่เคยกรอกไว้ในฟอร์ม รายการเว็บไซต์ที่เคยเยี่ยมชม เป็นต้น การใช้งานคุกกี้ช่วยเพิ่มความรวดเร็วในการเรียกข้อมูลเก่าโดยไปอ่านจากคุกกี้ได้บันทึกไว้ทันที แต่มีข้อเสียคือ อาจเป็นช่องโหว่ให้โปรแกรมไม่พึงประสงค์ เช่น สปายแวร์ (Spyware) แผงตัวเข้ามาล้วงข้อมูลจากเครื่องผู้ใช้ไปได้ ดังนั้น หากมีการใช้งานเว็บไซต์จากเครื่องสาธารณะควรทำการล้างข้อมูลคุกกี้ออกจากเครื่องที่ใช้งานทุกครั้งเพื่อความปลอดภัย ดังตัวอย่างภาพ

<img src=img/0604.png>

ที่มา: ภาพหน้าจอตั้งค่าล้างข้อมูลการท่องเว็บของโปรแกรมกูเกิลโครม

สำหรับการพัฒนาโปรแกรมบนเว็บด้วยภาษาพีเอชพี (PHP) สามารถสร้างข้อมูลคุกกี้ขึ้นมาใช้งานได้โดยผ่านตัวแปรคุกกี้ ```$_COOKIE[]``` ซึ่งการสร้างคุกกี้ใช้งานบนเว็บไซต์สามารถจำแนกได้ 2 ชนิด ได้แก่ 

1. คุกกี้แบบชั่วคราว เป็นคุกกี้ที่จัดเก็บอยู่ในคอมพิวเตอร์ผู้ใช้ จนกว่าจะมีคำสั่งลบค่าคุกกี้นั้นออกไป คุกกี้ประเภทนี้จะใช้ในการบริหารจัดการภายในระบบของโปรแกรมเว็บเบราว์เซอร์ ซึ่งการพัฒนาแอปพลิเคชันบนเว็บด้วยภาษาพีเอชพี (PHP) ต้องกำหนค่า 2 ส่วน คือ ชื่อคุกกี้ และ ค่าคุกกี้ โดยไม่ต้องกำหนดค่าเวลาหมดอายุ เช่น ตั้งคุกกี้เก็บชื่อผู้ใช้ด้วยคำสั่ง ```setcookie("UserName", $txtName);```

2. คุกกี้แบบจำกัดอายุ เป็นคุกกี้ที่จัดเก็บในคอมพิวเตอร์ของผู้ใช้จนกว่าจะหมดเวลาที่กำหนด เป็นคุกกี้ที่นิยมนำไปประยุกต์ในการพัฒนาแอปพลิเคชันบนเว็บ เช่น การควบคุมระยะเวลาการล็อกอินใช้งานระบบ ซึ่งในการสร้างคุกกี้เพื่อใช้งานในภาษาพีเอชพี (PHP) จะต้องกำหนดค่า 3 ส่วน คือ ชื่อคุกกี้ ค่าคุกกี้ และเวลาที่คุกกี้จะหมดอายุ เช่น ตั้งคุกกี้เก็บชื่อผู้ใช้ไว้ 1 ชั่วโมง ด้วยคำสั่ง ```setcookie("UserName", $txtName, time()+3600);```

### การสร้างและตั้งค่าคุกกี้
การสร้างและตั้งคุกกี้เพื่อใช้งานในภาษาพีเอชพี (PHP) จะสั่งการด้วยฟังก์ชัน setcookie() มีรูปแบบโครงสร้างคำสั่ง ดังนี้

```
setcookie(ชื่อคุกกี้, ค่าคุกกี้, เวลาหมดอายุ);
```

จากโครงสร้างฟังก์ชัน setcookie() มีรูปแบบให้ระบุค่าพารามิเตอร์ 3 ส่วน ได้แก่ ชื่อคุกกี้ ค่าคุกกี้ และ เวลาหมดอายุ โดยในการสร้างคุกกี้ขึ้นมาใช้งานสามารถกำหนดได้หลายค่าตามต้องการ ซึ่งวิธีการสร้างตัวแปรคุกกี้สามารถเขียนได้ตามตัวอย่างโปรแกรม

```
01:<?php
02:	   ob_start();
03:	   $txtName = " Steve Rogers";
04:	   $txtType = "Administrator";
05:	   setcookie("UserName", $txtName, time()+3600);
06:	   setcookie("UserType", $txtType, time()+3600);
07:	   echo "<B>Set Cookies</B><BR>"; 
08:	   echo "UserName: ".$txtName."<BR>";
09:	   echo "UserType: ".$txtType;
10:	   ob_end_flush();
11:?>
```

จากตัวอย่างโปรแกรม บรรทัดที่ 02 กับ บรรทัดที่ 07 เป็นฟังก์ชันสำหรับการเปิดและปิดการใช้เอาท์พุตบัพเฟอริ่ง (Output Buffering) ซึ่งนิยมใช้ในการใช้งานเกี่ยวกับคุกกี้ ในที่นี้ได้ประกาศตัวแปรที่จะใช้เป็นค่าคุกกี้ (บรรทัดที่ 03-04) และในบรรทัดที่ 05-06 เป็นการสร้างคุกกี้ จำนวน 2 ค่า ได้แก่ ชื่อผู้ใช้งาน (UserName) และ ประภทผู้ใช้ (UserType) มีอายุนับไปอีก 1 ชั่วโมง จากเวลาเครื่องเว็บเซิร์ฟเวอร์ แทนด้วย time()+3600 โดยที่หน่วยบวกค่าเวลาจะเป็นวินาที (กรณีที่ไม่ระบุเวลาจะเป็นการสร้างค่าคุกกี้แบบชั่วคราว) คุกกี้ที่สร้างไว้จะถูกบันทึกไว้ที่เครื่องของผู้ใช้เว็บเบราว์เซอร์ ในบรรทัดที่ 07-09 เป็นการแสดงสถานะและค่าของคุกกี้ที่ทำการสร้าง ซึ่งผลลัพธ์ของโปรแกรมจะเป็นไปตามภาพ

<img src=img/0605.png>

### การตรวจสอบและตั้งรับค่าคุกกี้
เนื่องจากคุกกี้ที่สร้างขึ้นบนเครื่องผู้ใช้จะมีทั้งคุกกี้ชั่วคราวและคุกกี้แบบกำหนดอายุ ดังนั้น การใช้งานคุกกี้จะต้องมีการตรวจสอบสถานะค่าคุกกี้ก่อนเพื่อทำการตั้งรับค่า โดยผ่านตัวแปร ```$_COOKIE[]``` ดังแสดงตามตัวอย่างโปรแกรม

```
01:<?php
02:	    ob_start();
03:	    if(!empty($_COOKIE['UserName'])) {
04:	          $UserName = $_COOKIE['UserName'];
05:	          $UserType = $_COOKIE['UserType'];
06:	          echo "<B>Get Cookies</B><BR>";
07:	          echo "User Name: ".$UserName."<BR>";
08:	          echo "User Type: ".$UserType;
09:	    } else {
10:	          echo "<B>Cleared Cookies</B>";
11:	    }
12:	    ob_end_flush();
13:?>
```

จากตัวอย่างโปรแกรม ในบรรทัดที่ 03 เป็นคำสั่งในการตรวจสอบค่าคุกกี้ ```$_COOKIE['UserName']``` ว่าเป็นค่าว่างหรือไม่ โดยผลลัพธ์จะเป็นไปได้ 2 ทางเลือก คือ ถ้าเป็น“จริง” จะทำคำสั่งบรรทัดที่ 04-08 กับ แต่ถ้าเป็น “เท็จ” จะทำคำสั่งบรรทัดที่ 10 ซึ่งผลลัพธ์ทั้ง 2 ทางเลือก แสดงดังภาพ

<img src=img/0606.png>

### การล้างค่าตัวแปรคุกกี้ 
โดยทั่วไปคุกกี้จะมีการกำหนดอายุของคุกกี้เอาไว้ อาทิเช่น กำหนดอายุคุกกี้ที่จัดเก็บสถานะการล็อกอินไว้ 1 ชั่วโมง ซึ่งเมื่อคุกกี้ดังกล่าวหมดอายุ สถานะค่าเพื่อตรวจสอบการล็อกอินเหล่านั้นก็จะหมดไปด้วย แต่ในกรณีที่มีการล็อกเอาท์ออกจากระบบโดยผู้ใช้ จะต้องทำการลบค่าคุกกี้นั้นทันที โดยใช้รูปแบบโครงสร้างคำสั่งดังนี้

```
setcookie(ชื่อคุกกี้ที่ต้องการล้างค่า);
```

การเขียนโปรแกรมล้างค่าคุกกี้แสดงในโปรแกรม

```
01:<?php 
02:	    ob_start();
03:	    setcookie("UserName");
04:	    setcookie("UserType");
05:	    echo "<B>Cleared Cookies</B>";
06:	    ob_end_flush();
07:?>
```

จากตัวอย่างโปรแกรม บรรทัด 03-04 เป็นการล้างคุกกี้ด้วยคำสั่ง setcookie() ทั้ง 2 ค่า คือ UserName และ UserType ที่ได้มีการตั้งค่าใช้สำหรับเก็บสถานะการล็อกอินผู้ใช้ระบบไว้ก่อนหน้า และในบรรทัดที่ 05 แสดงสถานะการล้างคุกกี้เพื่อการใช้งานต่อไปจะตรวจไม่พบค่าคุกกี้ดังกล่าว จากโปรแกรมดังกล่าวจะได้ผลลัพธ์ตามภาพ

<img src=img/0607.png>

การใช้งานคุกกี้มีลำดับการสร้างและติดตาม ได้แก่ การตั้งค่าคุกกี้ การตรวจสอบสถานะตัวแปรคุกกี้ และการล้างค่าคุกกี้ โดยเมื่อได้ทำการล้างคุกกี้หรือาสถานะคุกกี้หมดอายุจะไม่สามารถเรียกใช้งานค่าคุกกี้ได้อีก จนกว่าจะได้มีการตั้งค่าคุกกี้ขึ้นมาใหม่ ซึ่งฟังก์ชันที่เกี่ยวกับคุกกี้สามารถสรุปได้ดังตาราง

| ฟังก์ชัน | ความหมาย |	ตัวอย่างการใช้งาน |
| --- | --- | --- |
| ob_start(); | เริ่มเอาท์พุตบัพเฟอริ่ง | ทั่วไปจะเริ่มด้วย ob_start(); เพื่อสั่งให้เว็บเซิร์ฟเวอร์ส่งผลลัพธ์ไปให้ไคลเอ็นต์เมื่อสิ้นสุดเอาท์พุตบัพเฟอริ่งแล้ว ป้องกันการแจ้งข้อผิดพลาดระหว่างการเรียกใช้งานคุกกี้ซึ่งสามารถใช้งานจากหน้าอื่นได้ |
| ob_end_flush(); | สิ้นสุดเอาท์พุตบัพเฟอริ่ง | จะปิดด้วย ob_end_flush(); เสมอเมื่อสิ้นสุดเอาท์พุตบัพเฟอริ่ง |
| setcookie() | ตั้งค่าคุกกี้ | สามารถกำหนดได้ 2 รูป ได้แก่ 1.	สร้างคุกกี้ เช่น ```setcookie("UserName", $txtName, time()+3600);``` 2. ล้างคุกกี้ เช่น ```setcookie("UserName");``` สามารถตั้งตัวแปรรับค่าคุกกี้ ได้ เช่น ```$UserName = $_ COOKIE['UserName'];``` |

---
#### [<< หน้าก่อนหน้า](0601.md) | [หน้าเลือกหัวข้อ](README.md) | [หน้าต่อไป >>](0603.md)
---
